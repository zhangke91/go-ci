version: 0.1
component: build
timeoutInSeconds: 1000
runAs: root
shell: bash
env:
  variables:
    GO_VERSION: "1.21"
    # OCI Container Registry configuration
    DOCKER_REGISTRY: "sjc.ocir.io"
    DOCKER_REPOSITORY: "${TENANCY_NAMESPACE}/${REPO_NAME}"
    IMAGE_TAG: "${BUILD_RUN_ID}"
  vaultVariables:
    AUTH_TOKEN: ${AUTH_TOKEN_OCID}

steps:
  - type: Command
    name: "Install Go"
    command: |
      curl -O https://dl.google.com/go/go${GO_VERSION}.linux-amd64.tar.gz
      tar -xvf go${GO_VERSION}.linux-amd64.tar.gz
      mv go /usr/local
      export PATH=$PATH:/usr/local/go/bin
      go version

  - type: Command
    name: "Download dependencies"
    command: |
      export PATH=$PATH:/usr/local/go/bin
      go mod download

  - type: Command
    name: "Run tests"
    command: |
      export PATH=$PATH:/usr/local/go/bin
      go test -v ./...

  - type: Command
    name: "Build application"
    command: |
      export PATH=$PATH:/usr/local/go/bin
      CGO_ENABLED=0 GOOS=linux go build -o server

  - type: Command
    name: "Build and Push Docker Image"
    command: |
      echo "${AUTH_TOKEN}" | docker login ${DOCKER_REGISTRY} -u "${TENANCY_NAMESPACE}/${USERNAME}" --password-stdin
      docker build -t ${DOCKER_REGISTRY}/${DOCKER_REPOSITORY}:${IMAGE_TAG} .
      docker push ${DOCKER_REGISTRY}/${DOCKER_REPOSITORY}:${IMAGE_TAG}

outputArtifacts:
  - name: application
    type: BINARY
    location: server
  - name: docker-image
    type: DOCKER_IMAGE
    location: ${DOCKER_REGISTRY}/${DOCKER_REPOSITORY}:${IMAGE_TAG} 